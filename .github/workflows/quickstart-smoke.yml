name: Quickstart (jwt-allauth startproject)

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "*" ]

permissions:
  contents: read

jobs:
  quickstart:
    runs-on: ubuntu-latest
    environment:
      name: quickstart

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install django-jwt-allauth from this repository
        run: |
          python -m pip install --upgrade pip
          pip install .
          pip show django-jwt-allauth

      - name: Generate project with jwt-allauth startproject
        run: |
          jwt-allauth startproject myproject

      - name: Run migrations
        working-directory: myproject
        run: |
          python manage.py makemigrations jwt_allauth
          python manage.py migrate

      - name: Run Django system checks
        working-directory: myproject
        run: |
          python manage.py check

      - name: Runserver smoke test
        working-directory: myproject
        run: |
          python manage.py runserver 0.0.0.0:8000 &
          SERVER_PID=$!

          echo "Waiting for Django development server to start..."
          for i in {1..15}; do
            if curl -s -o /dev/null http://127.0.0.1:8000/; then
              echo "Django development server responded on /"
              break
            fi
            echo "Attempt $i/15: server not ready yet, retrying..."
            sleep 2
          done

          if ! curl -s -o /dev/null http://127.0.0.1:8000/; then
            echo "Server did not start correctly or did not respond in time"
            kill $SERVER_PID || true
            exit 1
          fi

          ROOT_STATUS=$(curl -s -o /dev/null -w "%{http_code}" http://127.0.0.1:8000/)
          echo "Root URL status: $ROOT_STATUS"

          JWT_LOGIN_STATUS=$(curl -s -o /dev/null -w "%{http_code}" http://127.0.0.1:8000/jwt-allauth/login/)
          echo "jwt-allauth login URL status: $JWT_LOGIN_STATUS"

          if [ "$ROOT_STATUS" = "000" ] || [ "$JWT_LOGIN_STATUS" = "000" ]; then
            echo "Failed to connect to one of the URLs during smoke test"
            kill $SERVER_PID || true
            exit 1
          fi

          if [ "$ROOT_STATUS" -ge 500 ] || [ "$JWT_LOGIN_STATUS" -ge 500 ] || [ "$JWT_LOGIN_STATUS" -eq 404 ]; then
            echo "Unexpected HTTP status codes for quickstart smoke test"
            kill $SERVER_PID || true
            exit 1
          fi

          echo "Shutting down Django development server"
          kill $SERVER_PID || true
